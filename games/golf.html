<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ミニミニ・パターゴルフ</title>
    <style>
        body { margin: 0; background: #2ecc71; font-family: sans-serif; overflow: hidden; touch-action: none; display: flex; flex-direction: column; align-items: center; }
        #game-header { color: white; padding: 10px; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); text-align: center; }
        canvas { display: block; background: #27ae60; border: 5px solid #1e8449; border-radius: 10px; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 100; }
        .btn { background: #f1c40f; color: #333; border: none; padding: 12px 30px; border-radius: 25px; font-size: 1.2rem; cursor: pointer; margin-top: 15px; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

    <div id="game-header">
        <h2 id="level-display">LEVEL 1</h2>
        <div style="font-size: 1.2rem;">今回の打数: <span id="strokes">0</span> / 合計: <span id="total-strokes">0</span></div>
    </div>

    <canvas id="canvas"></canvas>

    <div id="overlay">
        <h1 id="overlay-title">HOLE IN ONE!</h1>
        <p>合計打数: <span id="final-strokes">0</span></p>
        <button id="next-btn" class="btn" onclick="nextLevel()">次のホールへ</button>
        <a href="/" class="btn" style="background: #ecf0f1;">一覧に戻る</a>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
<script>
    const { Engine, Render, Runner, Bodies, Composite, Events, Body, Vector } = Matter;

    const engine = Engine.create();
    engine.world.gravity.y = 0;

    const canvas = document.getElementById('canvas');
    const width = Math.min(window.innerWidth - 20, 400);
    const height = Math.min(window.innerHeight - 150, 600);
    canvas.width = width;
    canvas.height = height;

    const render = Render.create({
        canvas: canvas,
        engine: engine,
        options: { width: width, height: height, wireframes: false, background: '#27ae60' }
    });

    let currentLevel = 1;
    let strokes = 0;
    let totalStrokes = 0;
    let ball, hole;
    let isDragging = false;
    let startPos = { x: 0, y: 0 };

    // --- レベル設計 ---
    function loadLevel(lv) {
        Composite.clear(engine.world);
        strokes = 0;
        document.getElementById('strokes').innerText = strokes;
        document.getElementById('level-display').innerText = "LEVEL " + lv;
        document.getElementById('overlay').style.display = 'none';

        const wallOptions = { isStatic: true, render: { fillStyle: '#1e8449' } };
        
        // 外枠
        const walls = [
            Bodies.rectangle(width/2, 0, width, 20, wallOptions),
            Bodies.rectangle(width/2, height, width, 20, wallOptions),
            Bodies.rectangle(0, height/2, 20, height, wallOptions),
            Bodies.rectangle(width, height/2, 20, height, wallOptions)
        ];

        // 障害物の配置
        if (lv === 1) {
            walls.push(Bodies.rectangle(width/2, height/2, 150, 20, wallOptions));
        } else if (lv === 2) {
            walls.push(Bodies.rectangle(width/3, height/3, 20, 200, wallOptions));
            walls.push(Bodies.rectangle(width*0.7, height*0.6, 20, 200, wallOptions));
        } else if (lv === 3) {
            walls.push(Bodies.rectangle(width/2, height/2, 200, 20, wallOptions));
            walls.push(Bodies.rectangle(width/2, height/2 - 100, 20, 100, wallOptions));
            walls.push(Bodies.rectangle(width/2, height/2 + 100, 20, 100, wallOptions));
        }

        hole = Bodies.circle(width/2, 80, 15, { isStatic: true, isSensor: true, render: { fillStyle: '#111' } });
        ball = Bodies.circle(width/2, height - 80, 8, { restitution: 0.8, frictionAir: 0.03, render: { fillStyle: '#fff' } });

        Composite.add(engine.world, [...walls, hole, ball]);
    }

    Render.run(render);
    Runner.run(Runner.create(), engine);

    const handleStart = (x, y) => {
        if (Vector.magnitude(ball.velocity) > 0.1) return;
        isDragging = true;
        const rect = canvas.getBoundingClientRect();
        startPos = { x: x - rect.left, y: y - rect.top };
    };

    const handleEnd = (x, y) => {
        if (!isDragging) return;
        isDragging = false;
        const rect = canvas.getBoundingClientRect();
        const endPos = { x: x - rect.left, y: y - rect.top };
        const diff = Vector.sub(startPos, endPos);
        Body.applyForce(ball, ball.position, Vector.mult(diff, 0.00005));
        strokes++;
        totalStrokes++;
        document.getElementById('strokes').innerText = strokes;
        document.getElementById('total-strokes').innerText = totalStrokes;
    };

    canvas.addEventListener('mousedown', e => handleStart(e.clientX, e.clientY));
    window.addEventListener('mouseup', e => handleEnd(e.clientX, e.clientY));
    canvas.addEventListener('touchstart', e => handleStart(e.touches[0].clientX, e.touches[0].clientY));
    window.addEventListener('touchend', e => handleEnd(e.changedTouches[0].clientX, e.changedTouches[0].clientY));

    Events.on(engine, 'afterUpdate', () => {
        if (!ball) return;
        const dist = Vector.magnitude(Vector.sub(ball.position, hole.position));
        if (dist < 15 && Vector.magnitude(ball.velocity) < 2) {
            Body.setVelocity(ball, { x: 0, y: 0 });
            ball.position = { x: hole.position.x, y: hole.position.y };
            showClearOverlay();
        }
    });

    function showClearOverlay() {
        document.getElementById('final-strokes').innerText = totalStrokes;
        const overlay = document.getElementById('overlay');
        const nextBtn = document.getElementById('next-btn');
        if (currentLevel < 3) {
            document.getElementById('overlay-title').innerText = "STAGE CLEAR!";
            nextBtn.innerText = "次のホールへ";
            nextBtn.style.display = "block";
        } else {
            document.getElementById('overlay-title').innerText = "ALL HOLES CLEAR!";
            nextBtn.style.display = "none";
        }
        overlay.style.display = 'flex';
    }

    function nextLevel() {
        currentLevel++;
        loadLevel(currentLevel);
    }

    loadLevel(1);
</script>
</body>
</html>
