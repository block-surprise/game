<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>P2Pネオン・ピンポン</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: sans-serif; text-align: center; overflow: hidden; touch-action: none; }
        canvas { background: #111; border-top: 5px solid #ff4d4d; border-bottom: 5px solid #007bff; display: block; margin: 0 auto; }
        .menu { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); padding: 20px; border-radius: 15px; border: 2px solid #007bff; width: 85%; max-width: 320px; z-index: 10; }
        input { width: 80%; padding: 12px; margin: 10px 0; border-radius: 5px; border: 1px solid #444; background: #222; color: #fff; }
        button { padding: 12px 24px; background: #007bff; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 5px; }
        #status { position: fixed; top: 10px; width: 100%; font-size: 12px; color: #007bff; text-shadow: 0 0 5px #007bff; }
        .mode-label { font-size: 0.8rem; color: #aaa; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="status">モード：1人プレイ (CPU対戦)</div>

<div id="menu" class="menu">
    <h2>ネオン・ピンポン</h2>
    <div class="mode-label">友達と対戦するには接続してください</div>
    <button onclick="startGameMode('solo')">今すぐ1人で遊ぶ</button>
    <hr style="border: 0.5px solid #333; margin: 20px 0;">
    <button onclick="createRoom()">部屋を作る</button>
    <input type="text" id="peerIdInput" placeholder="相手のIDを入力">
    <button onclick="joinRoom()" style="background: #28a745;">接続して対戦</button>
    <p id="myIdDisplay" style="font-size: 10px; word-break: break-all; color: #888;"></p>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const statusDiv = document.getElementById('status');
    const menu = document.getElementById('menu');

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let peer, conn;
    let isConnected = false;
    let isHost = true; // 1人プレイ時は自分がホスト扱い
    let gameState = {
        ball: { x: canvas.width/2, y: canvas.height/2, dx: 4, dy: 4 },
        p1: { x: canvas.width/2 - 40, y: canvas.height - 30, w: 80, h: 10 },
        p2: { x: canvas.width/2 - 40, y: 20, w: 80, h: 10 },
        score: { p1: 0, p2: 0 }
    };

    // --- 通信設定 ---
    peer = new Peer();
    peer.on('open', (id) => {
        document.getElementById('myIdDisplay').innerText = "あなたのID: " + id;
    });

    function createRoom() {
        isHost = true;
        statusDiv.innerText = "接続待機中...";
        peer.on('connection', (c) => {
            conn = c;
            setupConn();
        });
    }

    function joinRoom() {
        const id = document.getElementById('peerIdInput').value;
        if (!id) return alert("IDを入力してください");
        isHost = false;
        conn = peer.connect(id);
        setupConn();
    }

    function setupConn() {
        conn.on('open', () => {
            isConnected = true;
            menu.style.display = 'none';
            statusDiv.innerText = "モード：2人対戦中！";
            
            conn.on('data', (data) => {
                if (isHost) {
                    gameState.p2.x = data.px;
                } else {
                    gameState = data;
                }
            });
        });
    }

    // --- ゲーム開始 ---
    function startGameMode(mode) {
        if (mode === 'solo') {
            menu.style.display = 'none';
            statusDiv.innerText = "モード：1人プレイ (CPU対戦)";
        }
        loop();
    }

    function loop() {
        update();
        draw();
        requestAnimationFrame(loop);
    }

    function update() {
        if (isHost) {
            // ボールの移動
            let b = gameState.ball;
            b.x += b.dx;
            b.y += b.dy;

            // 壁バウンド
            if (b.x < 10 || b.x > canvas.width - 10) b.dx *= -1;

            // CPU操作 (接続されていない時だけ)
            if (!isConnected) {
                let cpuSpeed = 3.5; // 少し弱めに設定
                let targetX = b.x - gameState.p2.w / 2;
                gameState.p2.x += (targetX - gameState.p2.x) * 0.1;
            }

            // 衝突判定 (自分 P1)
            if (b.y > gameState.p1.y - 10 && b.x > gameState.p1.x && b.x < gameState.p1.x + gameState.p1.w) {
                if (b.dy > 0) {
                    b.dy *= -1.05; // 徐々に速く
                    b.y = gameState.p1.y - 10;
                }
            }
            // 衝突判定 (相手/CPU P2)
            if (b.y < gameState.p2.y + 20 && b.x > gameState.p2.x && b.x < gameState.p2.x + gameState.p2.w) {
                if (b.dy < 0) {
                    b.dy *= -1.05;
                    b.y = gameState.p2.y + 20;
                }
            }

            // 得点
            if (b.y < 0) { resetBall(); gameState.score.p1++; }
            if (b.y > canvas.height) { resetBall(); gameState.score.p2++; }

            if (isConnected) conn.send(gameState);
        } else {
            // ゲスト側は自分の位置を送るだけ
            if (isConnected) conn.send({ px: gameState.p1.x });
        }
    }

    function resetBall() {
        gameState.ball = { 
            x: canvas.width/2, 
            y: canvas.height/2, 
            dx: (Math.random() - 0.5) * 8, 
            dy: 4 * (Math.random() > 0.5 ? 1 : -1) 
        };
    }

    // 操作設定
    const handleMove = (e) => {
        let clientX = e.touches ? e.touches[0].clientX : e.clientX;
        gameState.p1.x = clientX - gameState.p1.w / 2;
        // 画面外へ出ないように制限
        if (gameState.p1.x < 0) gameState.p1.x = 0;
        if (gameState.p1.x > canvas.width - gameState.p1.w) gameState.p1.x = canvas.width - gameState.p1.w;
    };
    window.addEventListener('touchmove', handleMove);
    window.addEventListener('mousemove', handleMove);

    function draw() {
        ctx.fillStyle = '#111';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // センターライン
        ctx.strokeStyle = '#333';
        ctx.setLineDash([10, 10]);
        ctx.beginPath();
        ctx.moveTo(0, canvas.height/2);
        ctx.lineTo(canvas.width, canvas.height/2);
        ctx.stroke();

        // ボール (光る演出)
        ctx.shadowBlur = 15;
        ctx.shadowColor = '#fff';
        ctx.fillStyle = '#fff';
        ctx.beginPath();
        ctx.arc(gameState.ball.x, gameState.ball.y, 8, 0, Math.PI*2);
        ctx.fill();
        ctx.shadowBlur = 0;

        // パドル
        ctx.fillStyle = '#007bff'; // 自分
        ctx.fillRect(gameState.p1.x, gameState.p1.y, gameState.p1.w, gameState.p1.h);
        ctx.fillStyle = '#ff4d4d'; // 相手
        ctx.fillRect(gameState.p2.x, gameState.p2.y, gameState.p2.w, gameState.p2.h);

        // スコア表示
        ctx.font = "bold 40px sans-serif";
        ctx.fillStyle = "rgba(255,255,255,0.2)";
        ctx.fillText(gameState.score.p2, canvas.width/2 - 20, canvas.height/2 - 50);
        ctx.fillText(gameState.score.p1, canvas.width/2 - 20, canvas.height/2 + 80);
    }
</script>
</body>
</html>
