<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>P2Pネオン・ピンポン</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: sans-serif; text-align: center; overflow: hidden; touch-action: none; }
        canvas { background: #111; display: block; margin: 0 auto; width: 100vw; height: 100vh; object-fit: contain; }
        .menu { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.95); padding: 25px; border-radius: 15px; border: 2px solid #007bff; width: 85%; max-width: 320px; z-index: 10; }
        input { width: 80%; padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid #444; background: #222; color: #fff; }
        button { padding: 12px 20px; background: #007bff; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 5px; width: 90%; }
        #status { position: fixed; top: 10px; width: 100%; font-size: 12px; color: #007bff; z-index: 5; }
        #qrcode { background: white; padding: 10px; display: inline-block; margin-top: 10px; }
        #qrcode img { width: 150px; height: 150px; }
        .result-screen { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.95); padding: 30px; border-radius: 15px; display: none; z-index: 20; border: 2px solid #ffc107; width: 80%; }
    </style>
</head>
<body>

<div id="status">通信待機中...</div>

<div id="menu" class="menu">
    <h2 style="color:#007bff;">NEON PONG</h2>
    <button onclick="startGameMode('solo')">1人で練習 (CPU戦)</button>
    <hr style="border: 0.5px solid #333; margin: 20px 0;">
    <button onclick="createRoom()">対戦URL・QRを発行</button>
    <div id="shareArea" style="display:none;">
        <div id="qrcode"></div>
    </div>
    <input type="text" id="peerIdInput" placeholder="相手のIDを入力">
    <button onclick="joinRoom()" style="background: #28a745;">接続して対戦</button>
</div>

<div id="resultScreen" class="result-screen">
    <h1 id="resultText">WIN</h1>
    <p id="finalScore"></p>
    <button onclick="location.reload()" style="background:#ffc107; color:#000;">メニューへ</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const menu = document.getElementById('menu');

    // ★重要：論理サイズ（どんな端末でもこのサイズを基準に計算する）
    const V_WIDTH = 360;
    const V_HEIGHT = 640;
    canvas.width = V_WIDTH;
    canvas.height = V_HEIGHT;

    let peer, conn, isConnected = false, isHost = true, gameActive = false;
    const WINNING_SCORE = 7;

    let state = {
        bx: V_WIDTH/2, by: V_HEIGHT/2,
        bdx: 0, bdy: 0,
        p1x: V_WIDTH/2 - 40, 
        p2x: V_WIDTH/2 - 40,
        s1: 0, s2: 0
    };

    peer = new Peer();
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('room')) document.getElementById('peerIdInput').value = urlParams.get('room');

    function createRoom() {
        isHost = true;
        const inviteUrl = window.location.origin + window.location.pathname + "?room=" + peer.id;
        document.getElementById('shareArea').style.display = 'block';
        new QRCode(document.getElementById("qrcode"), { text: inviteUrl, width: 150, height: 150 });
        peer.on('connection', (c) => { conn = c; setupConn(); });
    }

    function joinRoom() {
        isHost = false;
        conn = peer.connect(document.getElementById('peerIdInput').value);
        setupConn();
    }

    function setupConn() {
        conn.on('open', () => {
            isConnected = true; gameActive = true; menu.style.display = 'none';
            if(isHost) { state.bdx = 4; state.bdy = 4; }
        });
        conn.on('data', (data) => {
            if (isHost) {
                state.p2x = V_WIDTH - data.px - 80; 
            } else {
                state = data;
            }
        });
    }

    function startGameMode(mode) {
        if (mode === 'solo') {
            isHost = true; isConnected = false; gameActive = true;
            menu.style.display = 'none'; state.bdx = 4; state.bdy = 4;
        }
    }

    function loop() {
        if (gameActive && isHost) update();
        if (!isHost && isConnected) conn.send({ px: state.p1x });
        draw();
        requestAnimationFrame(loop);
    }

    function update() {
        state.bx += state.bdx; state.by += state.bdy;
        if (state.bx < 8 || state.bx > V_WIDTH - 8) state.bdx *= -1;

        if (!isConnected) state.p2x += (state.bx - (state.p2x + 40)) * 0.15;

        // 当たり判定（下パドル）
        if (state.by > V_HEIGHT - 40 && state.bx > state.p1x && state.bx < state.p1x + 80) {
            state.bdy = -Math.abs(state.bdy) * 1.05; state.by = V_HEIGHT - 40;
        }
        // 当たり判定（上パドル）
        if (state.by < 40 && state.bx > state.p2x && state.bx < state.p2x + 80) {
            state.bdy = Math.abs(state.bdy) * 1.05; state.by = 40;
        }

        if (state.by < 0) { resetBall(); state.s1++; }
        if (state.by > V_HEIGHT) { resetBall(); state.s2++; }
        if (state.s1 >= WINNING_SCORE || state.s2 >= WINNING_SCORE) endGame();
        if (isConnected) conn.send(state);
    }

    function resetBall() {
        state.bx = V_WIDTH/2; state.by = V_HEIGHT/2;
        state.bdx = (Math.random()-0.5)*8; state.bdy = 4;
    }

    function endGame() {
        gameActive = false;
        document.getElementById('resultScreen').style.display = "block";
        const win = isHost ? (state.s1 > state.s2) : (state.s2 > state.s1);
        document.getElementById('resultText').innerText = win ? "VICTORY!" : "DEFEAT...";
        document.getElementById('finalScore').innerText = `${state.s1} - ${state.s2}`;
    }

    // タッチ座標を論理座標に変換
    function handleMove(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const scaleX = V_WIDTH / rect.width;
        state.p1x = (clientX - rect.left) * scaleX - 40;
    }
    window.addEventListener('touchmove', handleMove);
    window.addEventListener('mousemove', handleMove);

    function draw() {
        ctx.fillStyle = '#111'; ctx.fillRect(0, 0, V_WIDTH, V_HEIGHT);
        
        ctx.save();
        if (!isHost) {
            ctx.translate(V_WIDTH, V_HEIGHT);
            ctx.rotate(Math.PI);
        }

        // ボール
        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(state.bx, state.by, 8, 0, Math.PI*2); ctx.fill();
        // パドル
        ctx.fillStyle = '#007bff'; ctx.fillRect(state.p1x, V_HEIGHT-30, 80, 10);
        ctx.fillStyle = '#ff4d4d'; ctx.fillRect(state.p2x, 20, 80, 10);
        
        ctx.restore();

        // スコア表示
        ctx.font = "bold 40px sans-serif"; ctx.fillStyle = "rgba(255,255,255,0.2)";
        ctx.textAlign = "center";
        ctx.fillText(isHost?state.s2:state.s1, V_WIDTH/2, V_HEIGHT/2 - 50);
        ctx.fillText(isHost?state.s1:state.s2, V_WIDTH/2, V_HEIGHT/2 + 80);
    }

    loop();
</script>
</body>
</html>
